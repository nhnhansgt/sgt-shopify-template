# Config Guide - Shopify TOML Files

## shopify.app.toml

Main app configuration file in project root.

```toml
# shopify.app.toml
name = "My App"
api_version = "2025-10"

# Scopes - minimal permissions needed
scopes = "read_products,write_products,read_orders,write_orders"

# Webhooks
[[webhooks.subscriptions]]
topic = "app/uninstalled"
uri = "/webhooks/app/uninstalled"

[[webhooks.subscriptions]]
topic = "orders/create"
uri = "/webhooks/orders/create"

# Optional webhook filters
[[webhooks.subscriptions]]
topic = "products/update"
uri = "/webhooks/products/update"
filter = "{\"updated_at\":{\"query\":\"updated_at > NOW() - INTERVAL '1 hour'}}"
```

## shopify.extension.toml - UI Extensions

For Checkout, Admin, POS, Customer Account UI extensions.

```toml
# extensions/my-extension/shopify.extension.toml
api_version = "2025-10"

[[extensions]]
name = "My Checkout Extension"
description = "Adds banner to checkout"
handle = "my-checkout-extension"
type = "ui_extension"
uid = "auto-generated-by-cli"

[extensions.capabilities]
api_access = true       # Query Storefront API
network_access = true     # External API calls
block_progress = true     # Can block checkout

[[extensions.targeting]]
module = "./src/Extension.jsx"
target = "purchase.checkout.block.render"

# Optional: Metafields
[[extensions.targeting.metafields]]
namespace = "my-namespace"
key = "my-key"

# Optional: Merchant settings
[extensions.settings]
[[extensions.settings.fields]]
key = "banner_text"
type = "single_line_text_field"
name = "Banner text"
default = "Welcome!"
```

## shopify.extension.toml - Theme App Extensions

**CRITICAL**: Different structure than UI extensions.

```toml
# extensions/theme-extension/shopify.extension.toml
api_version = "unstable"

[[extensions]]
type = "theme_app_extension"
name = "My Theme Extension"
handle = "my-theme-extension"
uid = "auto-generated"

# NO [[extensions.targeting]] in TOML!
# NO [extensions.capabilities]
# Target goes in {% schema %} of block.liquid
```

**Block schema defines target:**

```liquid
<!-- extensions/theme-extension/blocks/my-block.liquid -->
<div>{{ block.settings.text }}</div>

{% schema %}
{
  "name": "My Block",
  "target": "section",
  "settings": [
    { "type": "text", "id": "text", "label": "Text" }
  ]
}
{% endschema %}
```

## shopify.extension.toml - Functions

For Discount, Validation, Transform functions.

```toml
# extensions/my-function/shopify.extension.toml
api_version = "2025-10"

[[extensions]]
type = "function"
name = "My Function"
handle = "my-function"
uid = "auto-generated"

# Function-specific configuration
# Varies by function type - query docs for exact syntax
```

## Common Targets by Extension Type

| Extension Type | Common Targets |
|----------------|----------------|
| Checkout UI | `purchase.checkout.block.render`, `purchase.checkout.delivery-address.render-before` |
| Admin Block | `admin.product-details.block.render`, `admin.order-details.block.render` |
| Admin Action | `admin.product-details.action.render` |
| Customer Account | `customer-account.order-status.block.render` |
| POS UI | `pos.cart.block.render`, `pos.cart.pre-progress-block.render` |
| Theme App Block | Target in block schema: `section`, `body`, `head` |

## Locale Files (for extensions)

**Schema locale files** (for theme app extension settings):
```json
// extensions/my-extension/locales/en.default.schema.json
{
  "my_extension": {
    "name": "My Extension",
    "settings": {
      "banner_text": "Banner text",
      "welcome_message": "Welcome!"
    }
  }
}
```

**Regular locale files** (for UI extensions):
```json
// extensions/my-extension/locales/en.default.json
{
  "name": "My Extension",
  "banner_text": "Banner text",
  "welcome_message": "Welcome!"
}
```

Use locale key in TOML:
```toml
name = "t:name"  # References locales/en.default.json
```

## Gotchas

1. **Filename**: Always `shopify.extension.toml` (NOT `extension.toml`)
2. **Handle is REQUIRED**: Must include `handle` field (lowercase, hyphens only)
3. **Theme apps**: NO `[[extensions.targeting]]` in TOML
4. **API version**: Use `api_version` (NOT `runtime_version` for theme apps)
5. **UID**: Auto-generated by CLI, don't change
6. **Capabilities**: NOT supported for theme_app_extension type
7. **{% stylesheet %}**: NOT allowed in theme app extension blocks - use separate .css file
8. **Schema locale files**: Must end with `.schema.json` (e.g., `en.default.schema.json`)
9. **No presets**: Theme app extension blocks don't support `presets` in schema (only theme sections do)

## Troubleshooting Common Errors

### "Missing handle for extension"
**Error:** `Missing handle for extension "Your Extension" at extensions/your-extension/shopify.extension.toml`

**Fix:** Add `handle` field to `[[extensions]]` section:
```toml
[[extensions]]
type = "theme_app_extension"
name = "Your Extension"
handle = "your-extension"  # ADD THIS - lowercase, hyphens only
uid = "auto-generated"
```

### "Extension must have only one default locale file"
**Error:** `[locales/en.default.schema] Must have a valid locale file extension format`

**Fix:** Rename locale file to include `.json` extension:
```bash
# Wrong:
locales/en.default.schema

# Correct:
locales/en.default.schema.json
```

### "Invalid tag 'schema': unknown key 'presets'"
**Error:** `[blocks/your-block.liquid] Invalid tag 'schema': unknown key 'presets'`

**Fix:** Remove `presets` from schema - theme app extension blocks don't use them:
```json
// REMOVE THIS from theme app extension blocks:
"presets": [
  { "name": "My Preset", "settings": {...} }
]

// Theme app extension schemas should only have:
{
  "name": "...",
  "target": "section",
  "settings": [...]
  // NO "presets" here!
}
```

### "Theme app extension blocks cannot contain 'stylesheet' tags"
**Error:** `Theme file blocks/your-block.liquid failed to validate: Theme app extension blocks cannot contain 'stylesheet' tags`

**Fix:** Move CSS to separate `.css` file in `assets/`:
```liquid
<!-- In blocks/your-block.liquid - REMOVE {% stylesheet %} -->
{% stylesheet %}
  .my-class { color: red; }
{% endstylesheet %}

<!-- REPLACE WITH: -->
{{ 'your-file.css' | asset_url | stylesheet_tag }}
```

Then create `assets/your-file.css`:
```css
.my-class { color: red; }
```

### "Theme app extension blocks cannot contain 'javascript' tags"
**Error:** Similar to stylesheet error

**Fix:** Move JS to separate `.js` file in `assets/`:
```liquid
<!-- In blocks/your-block.liquid - REMOVE {% javascript %} -->
{% javascript %}
  console.log('hello');
{% endjavascript %}

<!-- REPLACE WITH: -->
<script src="{{ 'your-file.js' | asset_url }}" defer></script>
```

Then create `assets/your-file.js`:
```javascript
console.log('hello');
```
