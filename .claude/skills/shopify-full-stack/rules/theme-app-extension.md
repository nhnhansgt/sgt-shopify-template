# Theme App Extension Rules

Validation rules and best practices. See [references/theme-app-extension.md](../references/theme-app-extension.md) for full schema/settings reference.

## TOML Rules

- **NEVER** write TOML from memory - always call MCP `search_docs_chunks` first
- **NEVER** manually edit `uid` - it's auto-generated by Shopify CLI
- Theme extensions use `type = "theme"` only - no `targeting` or `target` attributes in TOML
- Validate after any change: `shopify extension check`

```toml
# VALID
name = "my-extension"
type = "theme"
uid = "auto-generated-uuid"

# INVALID - theme extensions don't use targeting
[[extensions.targeting]]
target = "purchase.checkout.block.render"
```

## Liquid Validation (MANDATORY)

Every `.liquid` file must be validated via MCP:

1. Call `learn_shopify_api(api: "liquid")` to get conversationId
2. Call `validate_theme` with the extension path and changed files
3. Fix all errors, re-validate until clean

### Allowed Tags

`{% if %}`, `{% for %}`, `{% assign %}`, `{% capture %}`, `{% render %}`, `{% schema %}`, `{% stylesheet %}`, `{% javascript %}`, `{% doc %}`

### Forbidden Tags

`{% content_for_header %}`, `{% content_for_index %}`, `{% content_for_layout %}`

### Accessible Objects

- `block.settings.*`, `block.settings.product.metafields.*`
- `app.metafields.*`, `shop.metaobjects.*`
- Globals: `shop`, `request`, `customer`, etc.
- **NOT** parent `section` properties (except `section.id`)

## Schema Rules

| Rule             | Limit        |
| ---------------- | ------------ |
| Block `name`     | Max 25 chars |
| Setting `label`  | Max 50 chars |
| Translation keys | Max 50 chars |

- Don't include app name in block `name` - it appears automatically
- Use `autofill` only on resource settings (`product`, `collection`, etc.)
- Use only ONE of `enabled_on` or `disabled_on`, never both
- Don't enable on checkout templates (not supported)
- Don't use complex expressions in `available_if` - only simple metafield references

### Range Settings Rules

For `type: "range"` settings, TWO conditions must be satisfied:

1. **Step must evenly divide the range**: `(max - min) % step === 0`
2. **Total steps ≤ 101**: `(max - min) / step ≤ 101`

```json
// VALID: (100 - 0) / 1 = 100 steps ✓
{
  "type": "range",
  "id": "opacity",
  "min": 0,
  "max": 100,
  "step": 1
}

// VALID: (10 - 0) / 0.1 = 100 steps ✓
{
  "type": "range",
  "id": "z_index",
  "min": 0,
  "max": 10,
  "step": 0.1
}

// INVALID: (100 - 0) / 3 = 33.33... not divisible ✗
{
  "type": "range",
  "id": "z_index",
  "min": 0,
  "max": 100,
  "step": 3  // Error: step must evenly divide the range
}

// INVALID: (1000 - 0) / 1 = 1000 steps > 101 ✗
{
  "type": "range",
  "id": "z_index",
  "min": 0,
  "max": 1000,
  "step": 1  // Error: Range settings must have at most 101 steps
}
```

**Formula to verify**: `step = (max - min) / N` where N ≤ 101

## Snippet Rules

- Use `{% render %}` not `{% include %}`
- Variables from outside are not accessible inside snippets
- Always pass data explicitly: `{% render 'name', var: value %}`

## Locale Rules

- `en.default.json` is required as fallback
- File name must be extension name + ".json"
- Use hierarchical keys: `{ "feature": { "title": "...", "settings": {...} } }`
- Don't use flat/cryptic keys like `"t1"`, `"sr"`
- Always use `{{ 'key' | t }}` for user-facing text, never hardcode
- No comments or trailing commas in JSON

## Asset Rules

- Prefer schema `stylesheet`/`javascript` attributes over Liquid filters
- Don't use external CDNs - use extension assets/
- Use `asset_img_url` filter for images, never hardcode paths
- Use `defer` on script tags, lazy-load large bundles
- Use `enabled_on` for app embeds to limit page loading

## Security Rules

- No inline event handlers (`onclick="..."`)
- No `javascript:` URLs or `eval()`
- Use `$app:` prefix for app-owned metafields, not hardcoded namespace strings

## Pre-Deploy Checklist

- [ ] All `{% if %}` / `{% for %}` have closing tags
- [ ] Schema JSON is valid (no trailing commas, proper quotes)
- [ ] Block `name` < 25 chars, `label` < 50 chars
- [ ] No forbidden Liquid tags
- [ ] Range settings: `(max - min) % step === 0` AND `(max - min) / step ≤ 101`
- [ ] MCP `validate_theme` passes clean
- [ ] `shopify extension check` passes
- [ ] Tested in theme editor preview
- [ ] Translations display correctly

## Common Errors

| Error                                         | Fix                                                      |
| --------------------------------------------- | -------------------------------------------------------- |
| `Unexpected end of file`                      | Add missing `{% endif %}` or `{% endfor %}`              |
| `Invalid JSON` in schema                      | Fix commas, quotes, brackets                             |
| `Label too long`                              | Shorten name/label/keys to limits                        |
| `Unknown tag`                                 | Remove forbidden tags                                    |
| `Filter not found`                            | Check filter spelling                                    |
| `AssetSizeAppBlockCSS`                        | Reduce CSS size                                          |
| `AssetSizeAppBlockJavaScript`                 | Reduce JS or use lazy loading                            |
| `AppBlockValidTags`                           | Remove forbidden Liquid tags                             |
| `ImgWidthAndHeight`                           | Add `width`/`height` to `<img>` tags                     |
| `step must evenly divide the range`           | Set step so `(max - min) % step === 0`                   |
| `Range settings must have at most 101 steps`  | Reduce range or increase step: `(max - min) / step ≤ 101` |
