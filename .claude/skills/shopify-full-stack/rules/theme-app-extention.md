# Shopify Theme App Extension Rules

Best practices and rules for building valid Theme App Extensions.

## File Rules

### TOML Configuration (shopify.extension.toml)

**REQUIRED** properties:
- `name` - Extension handle (must match directory name)
- `type` - Must be `"theme"` for theme app extensions
- `uid` - Unique identifier (auto-generated by Shopify)

**DO NOT** manually edit `uid` - it's generated by Shopify CLI.

### Valid TOML Config

```toml
name = "my-theme-extension"
type = "theme"
uid = "auto-generated-uuid"
```

### Invalid TOML Configs

**DO NOT** use:
```toml
# WRONG - Missing required properties
name = "extension"

# WRONG - Invalid type
type = "ui_extension"

# WRONG - Theme extensions don't use targeting/target attributes
[[extensions.targeting]]
target = "purchase.checkout.block.render"
```

### TOML Property Comparison

| Property | Theme Extension | UI Extension | Function |
|-----------|----------------|-------------|----------|
| `type` | `"theme"` | `"ui_extension"` | `"function"` |
| `targeting` | Not used | Required | Not used |
| `uid` | Required | Required | Required |

## Block Rules

### Target Placement Rules

**App Blocks** (for inline content):
- Use `target: "section"`
- Merchant adds to theme sections manually
- Can use `autofill` for resource settings

**App Embed Blocks** (for floating/overlay content):
- Use `target: "head"`, `"body"`, or `"compliance_head"`
- Injected before closing tags automatically
- Merchant activates in Theme Settings > App embeds

### Target Selection

| Use Case | Target |
|----------|--------|
| Product reviews, ratings | `"section"` |
| Floating chat widget | `"body"` |
| Analytics scripts | `"head"` |
| Cookie consent banner | `"compliance_head"` |

### Conditional Rendering

**DO** use `available_if` for conditional blocks:
```liquid
{% schema %}
{
  "available_if": "{{ app.metafields.namespace.key }}"
}
{% endschema %}
```

**DO NOT** use complex Liquid expressions in `available_if`:
```liquid
# WRONG - Complex expressions not supported
"available_if": "{{ app.metafields.namespace.key and request.page_type == 'product' }}"
```

## Schema Rules

### Naming Conventions

**DO** keep block names under 25 characters:
```json
{ "name": "Star Rating" }  // GOOD
{ "name": "Product Star Rating Display Widget With Reviews" }  // TOO LONG
```

**DO NOT** include app name in block name (it appears automatically in theme editor).

### Settings Best Practices

**DO** use `autofill` for resource settings that should sync with parent section:
```json
{ "type": "product", "id": "product", "autofill": true }
```

**DO NOT** use `autofill` for non-resource settings (causes errors).

**DO** use descriptive, hierarchical locale keys:
```json
{ "label": "reviews.settings.show_rating" }
```

**DO NOT** use cryptic keys:
```json
{ "label": "sr" }  // AVOID
```

### Template Restrictions

**DO** use `enabled_on` to limit to templates:
```json
"enabled_on": {
  "templates": ["product", "index"]
}
```

**DO NOT** enable on checkout templates (not supported):
```json
# WRONG - Checkout templates not supported
"enabled_on": {
  "templates": ["checkout", "order_status"]
}
```

**USE ONLY ONE** of `enabled_on` or `disabled_on`, never both.

## Liquid Rules

### Tags Allowed in Theme App Extensions

**ALLOWED**:
- Standard Liquid logic tags: `{% if %}`, `{% for %}`, `{% assign %}`, `{% capture %}`, `{% render %}`
- `{% schema %}` for block configuration
- `{% stylesheet %}` and `{% javascript %}` for component code
- `{% doc %}` for LiquidDoc documentation

**FORBIDDEN** in app blocks/app embeds:
- `{% content_for_header %}` - Not accessible
- `{% content_for_index %}` - Not accessible
- `{% content_for_layout %}` - Not accessible

### Object Access Rules

**ALLOWED** in app blocks:
- `block.settings.*` - Block's own settings
- `block.settings.product.metafields.*` - Product metafields if product setting exists
- `app.metafields.*` - App metafields
- `shop.metaobjects.*` - Metaobjects
- Global objects: `shop`, `request`, `customer`, etc.

**NOT ALLOWED**:
- Parent section properties (except `section.id`)
- Content_for_* objects

### Snippet Rendering

**DO** use `{% render %}` for snippets (not `{% include %}`):
```liquid
{% render 'snippet_name', param: value %}
```

**DO NOT** access variables created outside snippet:
```liquid
# WRONG - Outside variables not accessible
{% assign my_var = "value" %}
{% render 'snippet' %}  # my_var not available inside
```

**DO** pass parameters explicitly:
```liquid
{% render 'snippet', my_var: "value" %}
```

## Locale Rules

### File Structure

**REQUIRED** files:
- `locales/en.default.json` - English translations (fallback)

**OPTIONAL** files:
- `locales/en.default.schema.json` - Schema locale for theme editor
- `locales/*.json` - Other languages
- `locales/*.schema.json` - Schema locales for other languages

### Locale Key Organization

**DO** use hierarchical, descriptive keys:
```json
{
  "feature_name": {
    "title": "Feature Title",
    "settings": {
      "option_a": "Option A"
    },
    "messages": {
      "success": "Success!",
      "error": "Error occurred"
    }
  }
}
```

**DO NOT** use flat or cryptic keys:
```json
{
  "t1": "Title",
  "o1": "Option 1",
  "m1": "Message 1"
}
```

### Translation Usage

**DO** always use `{{ 'key' | t }}` for user-facing text:
```liquid
<h2>{{ 'reviews.title' | t }}</h2>
```

**DO NOT** hardcode text (prevents localization):
```liquid
<h2>Customer Reviews</h2>  <!-- AVOID -->
```

## Asset Rules

### CSS and JavaScript Loading

**PREFERRED** - Use schema attributes for auto-loading:
```json
{
  "stylesheet": "styles.css",
  "javascript": "app.js"
}
```

**ALTERNATIVE** - Use Liquid filters for conditional loading:
```liquid
<link rel="stylesheet" href="{{ 'styles.css' | asset_url }}">
```

**DO NOT** use external CDNs (performance impact):
```liquid
<!-- AVOID external resources -->
<link href="https://cdn.example.com/styles.css">
```

### Asset Size Guidelines

**CSS**: Keep under 100 KB compressed (suggested limit)
**JavaScript**: Keep under 10 KB compressed (suggested limit)

For larger bundles:
- Use import on interaction pattern for JS
- Lazy load when needed

### Image Assets

**DO** use `asset_img_url` filter for images:
```liquid
{{ 'product.jpg' | asset_img_url: width: 500, height: 500, crop: 'center' }}
```

**DO NOT** hardcode image paths:
```liquid
<img src="/assets/product.jpg">  <!-- WRONG -->
```

## Performance Rules

### Script Loading

**GOOD** - Import on interaction for large JS:
```liquid
<button id="load-widget">Load Widget</button>
<script>
  document.getElementById('load-widget').addEventListener('click', () => {
    import("{{ 'widget.js' | asset_url }}")
      .then(module => module.default())
      .catch(console.error);
  });
</script>
```

**AVOID** - Auto-loading large scripts:
```liquid
<!-- AVOID for large files -->
<script src="{{ 'widget.js' | asset_url }}"></script>
```

### App Embed Block Page Specificity

**DO** use `enabled_on` for app embeds to limit page loading:
```json
{
  "name": "Product Widget",
  "target": "body",
  "enabled_on": {
    "templates": ["product"]
  }
}
```

This ensures scripts only load where needed.

## Validation Rules

### Required Validation

**ALWAYS** validate extension before deploying:
```bash
shopify extension check
```

**Fix all** errors before deployment.

### Common Validation Errors

| Error | Fix |
|-------|-----|
| `AssetSizeAppBlockCSS` | Reduce CSS file size |
| `AssetSizeAppBlockJavaScript` | Reduce JS file size or use lazy loading |
| `AppBlockValidTags` | Remove forbidden Liquid tags |
| `LiquidHTMLSyntaxError` | Fix Liquid syntax |
| `ImgWidthAndHeight` | Add width/height to `<img>` tags |

## Deep Linking Rules

### Deep Link Construction

**DO** use correct deep link format:
```
https://<shopDomain>/admin/themes/current/editor?template=<template>&addAppBlockId=<api_key>/<handle>&target=<target>
```

**DO** verify template/section exists before deep linking (use `read_themes` scope).

**DO NOT** hardcode shop domain - retrieve from Shop Admin API.

### API Key vs UUID

**USE** `api_key` (preferred):
```
addAppBlockId=<client_id>/<handle>
```

**DEPRECATED** - `uuid` (do not use):
```
addAppBlockId=<extension_id>/<handle>
```

## Security Rules

### Content Security

**DO NOT** include:
- Inline event handlers: `onclick="..."`
- `javascript:` URLs
- `eval()` or similar dangerous functions

**DO** use event listeners in separate JS files:
```javascript
// GOOD
document.getElementById('button').addEventListener('click', handler);
```

### Metafield Access

**DO** use reserved prefixes `$app:` for app-owned metafields:
```liquid
{{ block.settings.product.metafields["$app:custom"].my_key.value }}
```

**DO NOT** hardcode app-specific namespace values:
```liquid
<!-- AVOID - breaks across environments -->
{{ block.settings.product.metafields["my_app_namespace_v1"].key.value }}
```

## Testing Rules

### Testing Checklist

**ALWAYS** test:
1. Block renders correctly in theme editor preview
2. Settings save and apply correctly
3. Block works on different templates (if `enabled_on` varies)
4. Autofill connects to parent resource correctly
5. Assets load from CDN
6. Translations display correctly
7. Deep links navigate correctly

**TEST** in multiple themes (Dawn, Crave, etc.) to verify compatibility.

## Code Quality Rules

### Liquid Style

**DO** follow Liquid style guidelines:
- Use `{%- ... -%}` for trimming whitespace where appropriate
- Use descriptive variable names
- Add `{% doc %}` comments to snippets

**DO NOT**:
- Leave excessive whitespace in output
- Use single-letter variables except loop indices
- Leave commented-out code in files

### JSON/Locale Style

**DO** keep locale files organized and readable:
- Use 2-space indentation
- Keep keys in logical groups
- Add trailing commas (allowed in locales)

**DO NOT**:
- Use comments in JSON (not supported in theme app extensions)
- Mix naming conventions inconsistently

## Migration Rules

### From ScriptTag

**DO** migrate ScriptTag integrations to app embed blocks:
- Use `target: "head"` for scripts
- Use `enabled_on` for page-specific loading
- Remove ScriptTag creation from app code

**Benefits** of app embeds over ScriptTag:
- Page-specific script loading (better performance)
- Theme editor integration
- Settings for merchant customization

### From Asset API

**DO NOT** use Asset API to modify theme files directly (requires exemption).

**DO** use theme app extensions instead:
- App blocks for inline content
- App embeds for global additions
- Deep linking for guided setup
